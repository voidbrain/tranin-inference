<div class="listen-container">
  <h2>ğŸ¤ Speech Recognition Studio</h2>

  <!-- Backend Connection Status -->
  <div class="connection-status">
    <span class="connection-indicator">
      <span class="led" [class]="getWebSocketService().getBackendConnectionState()"></span>
      Backend: {{ getWebSocketService().getBackendConnectionState() === 'connected' ? 'Connected' :
                  getWebSocketService().getBackendConnectionState() === 'connecting' ? 'Connecting...' :
                  'Disconnected' }}
    </span>
  </div>

  <!-- Language Selection -->
  <div class="language-selection">
    <h3>ğŸŒ Language Selection:</h3>
    <div class="radio-group">
      <label class="radio-option">
        <input type="radio" name="language" value="multi" [(ngModel)]="selectedLanguage">
        <span>ğŸ³ï¸ Multilingual (EN + IT)</span>
      </label>
      <label class="radio-option">
        <input type="radio" name="language" value="en" [(ngModel)]="selectedLanguage">
        <span>ğŸ‡ºğŸ‡¸ English</span>
      </label>
      <label class="radio-option">
        <input type="radio" name="language" value="it" [(ngModel)]="selectedLanguage">
        <span>ğŸ‡®ğŸ‡¹ Italian</span>
      </label>
    </div>
  </div>

  <!-- Recording Controls -->
  <div class="recording-section">
    <h3>ğŸ™ï¸ Audio Recording</h3>

    <div class="control-buttons">
      <button (click)="startRecording()" [disabled]="isRecording || isStartingRecording" class="record-btn">
        <span *ngIf="!isRecording && !isStartingRecording">â–¶ï¸ Start</span>
        <span *ngIf="isStartingRecording">â³ Starting...</span>
        <span *ngIf="isRecording">âºï¸ Recording...</span>
      </button>
      <button (click)="stopRecording()" [disabled]="!isRecording" class="stop-btn">
        â¹ï¸ Stop
      </button>
      <button (click)="resetRecording()" class="reset-btn">
        ğŸ”„ Reset
      </button>
    </div>

    <div class="audio-display">
      <div *ngIf="audioBlob" class="audio-info">
        <strong>Audio Ready</strong> ({{ audioDuration || '0' }} seconds, {{ audioSize || '0' }} MB)
      </div>
      <div *ngIf="!audioBlob" class="audio-info">
        No audio recorded
      </div>
    </div>
  </div>

  <!-- Audio Playback -->
  <div *ngIf="audioBlob" class="audio-playback-section">
    <h3>ğŸ”Š Listen to {{ audioSource === 'uploaded' ? 'Uploaded' : 'Recorded' }} Audio</h3>
    <div class="audio-player">
      <audio controls [src]="audioUrl" class="audio-element">
        Your browser does not support the audio element.
      </audio>
      <div class="audio-controls">
        <button (click)="downloadAudio()" class="download-btn">
          â¬‡ï¸ Download Audio
        </button>
      </div>
      <p class="audio-note">ğŸµ Play your recorded audio before transcribing</p>
    </div>
  </div>

  <!-- Alternative Audio Upload -->
  <div class="audio-upload-section">
    <h3>ğŸ“ Upload Audio File</h3>
    <p class="upload-note">ğŸ’¡ Alternative to microphone recording - upload an audio file directly</p>
    <div class="upload-controls">
      <input type="file" accept="audio/*,.webm" (change)="onAudioFileSelected($event)" #audioFileInput class="file-input">
      <button (click)="audioFileInput.click()" class="upload-btn">
        ğŸ“ Choose Audio File
      </button>
      <button (click)="processUploadedAudio()" [disabled]="!selectedAudioFile" class="process-upload-btn">
        ğŸµ Load Audio
      </button>
    </div>
    <div *ngIf="selectedAudioFile" class="file-info">
      ğŸ“„ Selected: {{ selectedAudioFile.name }} ({{ formatFileSize(selectedAudioFile.size) }})
    </div>
  </div>

  <!-- Transcription Results -->
  <div class="transcription-section">
    <h3>ğŸ“ Transcription Result:</h3>
    <div class="transcription-controls">
      <button (click)="transcribeAudio()" [disabled]="!audioBlob || isTranscribing" class="transcribe-btn">
        <span *ngIf="!isTranscribing">ğŸ¯ Transcribe</span>
        <span *ngIf="isTranscribing">â³ Transcribing...</span>
      </button>
    </div>

    <div class="transcript-input">
      <textarea [(ngModel)]="transcript" placeholder="Transcription result will appear here..." [readonly]="!transcript"></textarea>
      <div *ngIf="transcript" class="edit-controls">
        <small>ğŸ’¡ Edit the transcription if needed, then upload for training</small>
      </div>
    </div>

    <!-- Transcription Details -->
    <div *ngIf="transcript && transcriptionLanguage" class="transcription-details">
      <div class="detail-item">
        <strong>ğŸŒ Language:</strong> {{ getLanguageDisplayName(transcriptionLanguage) }} ({{ transcriptionLanguage }})
      </div>
      <div class="detail-item">
        <strong>ğŸ¯ Confidence:</strong> {{ transcriptionConfidence | percent:'1.1-1' }}
      </div>
      <div class="detail-item">
        <strong>â±ï¸ Duration:</strong> {{ transcriptionDuration | number:'1.1-1' }} seconds
      </div>
    </div>
  </div>

  <!-- Training Data Upload - English -->
  <div class="training-section">
    <h3>ğŸš€ English Speech Recognition Training</h3>
    <p>Upload your recorded audio for LoRA fine-tuning the English Whisper model.</p>

    <div class="training-controls">
      <button (click)="uploadForTraining()" [disabled]="!audioBlob || isUploading || selectedLanguage !== 'en'" class="upload-btn">
        <span *ngIf="!isUploading">â¬†ï¸ Upload for English Training</span>
        <span *ngIf="isUploading">â³ Uploading...</span>
      </button>

      <button (click)="startEnglishTraining()" [disabled]="(languageCounts['en'] || 0) === 0 || isTraining" class="train-btn">
        <span *ngIf="!isTraining">ğŸ¯ Start English LoRA Training</span>
        <span *ngIf="isTraining">â³ Training in Progress...</span>
      </button>

      <button (click)="resetTrainingData('en')" [disabled]="(languageCounts['en'] || 0) === 0" class="reset-training-btn">
        ğŸ—‘ï¸ Clear English Training Data ({{ languageCounts['en'] || 0 }} items)
      </button>
    </div>

    <div class="training-info">
      <p><strong>English Training Status:</strong> {{
        (languageCounts['en'] || 0) === 0 ? 'No English training data uploaded yet' :
        `Ready for English training (${languageCounts['en'] || 0} audio samples)`
      }}</p>
      <p><small>Upload English audio recordings to create a speech recognition training dataset. Then start LoRA fine-tuning to improve Whisper's accuracy for English.</small></p>
    </div>
  </div>

  <!-- Training Data Upload - Italian -->
  <div class="training-section">
    <h3>ğŸš€ Italian Speech Recognition Training</h3>
    <p>Upload your recorded audio for LoRA fine-tuning the Italian Whisper model.</p>

    <div class="training-controls">
      <button (click)="uploadForTraining()" [disabled]="!audioBlob || isUploading || selectedLanguage !== 'it'" class="upload-btn">
        <span *ngIf="!isUploading">â¬†ï¸ Upload for Italian Training</span>
        <span *ngIf="isUploading">â³ Uploading...</span>
      </button>

      <button (click)="startItalianTraining()" [disabled]="(languageCounts['it'] || 0) === 0 || isTraining" class="train-btn">
        <span *ngIf="!isTraining">ğŸ¯ Start Italian LoRA Training</span>
        <span *ngIf="isTraining">â³ Training in Progress...</span>
      </button>

      <button (click)="resetTrainingData('it')" [disabled]="(languageCounts['it'] || 0) === 0" class="reset-training-btn">
        ğŸ—‘ï¸ Clear Italian Training Data ({{ languageCounts['it'] || 0 }} items)
      </button>
    </div>

    <div class="training-info">
      <p><strong>Italian Training Status:</strong> {{
        (languageCounts['it'] || 0) === 0 ? 'No Italian training data uploaded yet' :
        `Ready for Italian training (${languageCounts['it'] || 0} audio samples)`
      }}</p>
      <p><small>Upload Italian audio recordings to create a speech recognition training dataset. Then start LoRA fine-tuning to improve Whisper's accuracy for Italian.</small></p>
    </div>
  </div>

  <!-- Status Display -->
  <div class="status-section">
    <div class="status-card">
      <h4>ğŸ“Š System Status</h4>
      <div class="status-details">
        <div class="status-item">
          <strong>Whisper Model:</strong> {{ whisperStatus }}
        </div>
        <div class="status-item">
          <strong>Language:</strong> {{ getLanguageDisplayName(selectedLanguage) }}
        </div>
        <div class="status-item">
          <strong>Status:</strong> {{ status }}
        </div>
      </div>
    </div>

    <div class="message-display">
      <div *ngIf="lastMessage" class="message" [ngClass]="{'success': lastMessageType === 'success', 'error': lastMessageType === 'error'}">
        {{ lastMessage }}
      </div>
    </div>
  </div>
</div>
