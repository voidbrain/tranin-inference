<div class="see-container">
  <h2>ğŸ‘ï¸ Vision AI Studio (YOLO)</h2>

  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button (click)="activeTab.set('detect')"
            [class.active]="activeTab() === 'detect'"
            class="tab-btn">
      ğŸ¯ Detect
    </button>
    <button (click)="activeTab.set('train')"
            [class.active]="activeTab() === 'train'"
            class="tab-btn">
      ğŸš€ Train
    </button>
    <button (click)="activeTab.set('logs')"
            [class.active]="activeTab() === 'logs'"
            class="tab-btn">
      ğŸ“Š Logs
    </button>
  </div>

  <!-- DETECTION TAB CONTENT -->
  <div class="tab-content" *ngIf="activeTab() === 'detect'">
    <!-- Detection Mode Selector -->
    <div class="detection-mode-section">
      <h3>Detection Mode:</h3>
      <div class="mode-buttons">
        <label class="mode-option">
          <input type="radio"
                 name="detectionMode"
                 value="digits"
                 [(ngModel)]="detectionMode"
                 (change)="loadAvailableTags()">
          <span class="mode-label">ğŸ”¢ Digits</span>
        </label>
        <label class="mode-option">
          <input type="radio"
                 name="detectionMode"
                 value="colors"
                 [(ngModel)]="detectionMode"
                 (change)="loadAvailableTags()">
          <span class="mode-label">ğŸ¨ Colors (dashed boxes)</span>
        </label>
      </div>
    </div>

    <div class="camera-section">
      <button (click)="startCamera()" [disabled]="!isComponentReady() || isCameraActive()">Start Camera</button>
      <button (click)="stopCamera()" [disabled]="!isCameraActive()">Stop Camera</button>
    </div>

    <div class="live-view">
      <!-- Live video - hidden when detecting -->
      <video #videoElement
             [muted]="true"
             autoplay
             playsinline
             [class.detecting]="showStaticImage()"></video>

      <!-- Static captured image - shown when video is paused -->
      <img #staticImageElement
           [src]="capturedImage()"
           [class.detecting]="showStaticImage()"
           class="captured-image"
           alt="Captured frame">

      <!-- Bounding box canvas (always visible) -->
      <canvas #canvasElement
              [width]="canvasWidth()"
              [height]="canvasHeight()"
              [class.active]="isCorrectionMode()"
              class="overlay-canvas"
              (mousedown)="onMouseDown($event)"
              (mousemove)="onMouseMove($event)"
              (mouseup)="onMouseUp($event)"></canvas>
    </div>

    <div class="detection-controls">
      <button (click)="detectObjects()" [disabled]="!isCameraActive() || isDetecting()">Detect Objects</button>
    </div>

    <div class="detections">
      <h3>Detections:</h3>
      <div class="detections-list" *ngIf="detections().length > 0">
        <div class="detection-item" *ngFor="let detection of detections(); trackBy: trackByIndex">
          <span class="detection-label">{{ detection.label }}</span>
          <span class="detection-confidence">({{ detection.confidence }}%)</span>
        </div>
      </div>
      <div class="no-detections" *ngIf="detections().length === 0 && !isLoading()">
        No detections
      </div>
    </div>

    <div class="correction-section" *ngIf="detections().length > 0">
      <h3>Corrections</h3>
      <button (click)="enterCorrectionMode()" [disabled]="isCorrectionMode()">Edit Boxes</button>
      <button (click)="sendToBackend()" [disabled]="!canSendToBackend()">Send to Backend</button>
    </div>

    <div class="correction-controls" *ngIf="isCorrectionMode()">
      <p><strong>Correction Mode:</strong></p>
      <ul>
        <li>Click on green boxes to <span style="color: red">remove</span> them</li>
        <li>Click and drag green boxes to <span style="color: blue">move</span> them</li>
        <li>Select a label below, then click "Add Box" and draw on image (can add multiple)</li>
        <li>Boxes will turn green when completed</li>
      </ul>

      <!-- Predefined tags -->
      <div class="tag-section">
        <h4>Select Label:</h4>
        <div class="tag-buttons">
          <button *ngFor="let tag of availableTags()"
                  (click)="selectTag(tag)"
                  [class.selected]="newBoxLabel() === tag"
                  class="tag-btn">
            {{ tag }}
          </button>
        </div>
      </div>

      <div class="add-box-input">
        <input type="text"
               placeholder="Or enter custom label"
               [value]="newBoxLabel()"
               (input)="newBoxLabel.set($event.target.value)" />

        <div class="add-box-buttons">
          <button (click)="toggleAddBoxMode()"
                  [class.active]="addBoxMode()">
            {{ addBoxMode() ? 'Stop Adding' : 'Add Box' }}
          </button>
          <button (click)="clearAllBoxes()" class="clear-btn" *ngIf="detections().length > 0">
            Clear All
          </button>
        </div>
      </div>
    </div>

    <div class="status">
      <span>Status: {{ status() }}</span>
      <div class="debug-info" style="font-size: 12px; color: #666; margin-top: 5px;">
        Camera: {{ isCameraActive() ? 'âœ“' : 'âœ—' }} |
        Detecting: {{ isDetecting() ? 'âœ“' : 'âœ—' }} |
        Loading: {{ isLoading() ? 'âœ“' : 'âœ—' }} |
        Detections: {{ detections().length }} |<br>
        Static Image: {{ showStaticImage() ? 'âœ“' : 'âœ—' }} |
        Image Data: {{ capturedImage().substring(0, 50) + '...' }}<br>
        Current Labels: {{ getLabelsList() }}
      </div>
    </div>
  </div>

  <!-- TRAIN TAB CONTENT -->
  <div class="tab-content" *ngIf="activeTab() === 'train'">
    <!-- Training Queue Status -->
    <div class="queue-status-card">
      <h3>ğŸ“Š Training Queue Status</h3>

      <div class="status-grid">
        <div class="status-item">
          <div class="status-icon">ğŸ–¼ï¸</div>
          <div class="status-info">
            <div class="status-number">{{ trainingStatus()?.images_waiting || 0 }}</div>
            <div class="status-label">Images Ready</div>
            <div class="status-desc">Annotated images waiting for training</div>
          </div>
        </div>

        <div class="status-item">
          <div class="status-icon">ğŸƒâ€â™‚ï¸</div>
          <div class="status-info">
            <div class="status-number">{{ trainingStatus()?.training_sessions || 0 }}</div>
            <div class="status-label">Training Sessions</div>
            <div class="status-desc">Total training runs completed</div>
          </div>
        </div>

        <div class="status-item">
          <div class="status-icon">ğŸ“‚</div>
          <div class="status-info">
            <div class="status-number">{{ trainingStatus()?.total_images_annotated || 0 }}</div>
            <div class="status-label">Total Annotated</div>
            <div class="status-desc">Images processed since start</div>
          </div>
        </div>

        <div class="status-item">
          <div class="status-icon">ğŸ”„</div>
          <div class="status-info">
            <div class="status-number">{{ trainingStatus()?.processed_images || 0 }}</div>
            <div class="status-label">Images Processed</div>
            <div class="status-desc">Moved to archive after training</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Model Information -->
    <div class="model-info-card">
      <h3>ğŸ¤– Current Model Info</h3>
      <div class="model-details">
        <div class="model-item">
          <strong>Active Model:</strong> {{ trainingStatus()?.current_model || 'YOLOv8n (Base)' }}
        </div>
        <div class="model-item" *ngIf="trainingStatus()?.last_training_time">
          <strong>Last Training:</strong> {{ formatDateTime(trainingStatus()?.last_training_time || null) }}
        </div>
        <div class="model-item" *ngIf="!trainingStatus()?.last_training_time">
          <strong>Last Training:</strong> Never trained
        </div>
      </div>
    </div>

    <!-- Training Controls -->
    <div class="training-controls-card" *ngIf="trainingStatus()?.ready_for_training">
      <h3>ğŸš€ General Training</h3>

      <div class="training-params">
        <div class="param-group">
          <label for="epochs">Epochs:</label>
          <input type="number"
                 id="epochs"
                 min="1"
                 max="100"
                 [(ngModel)]="epochs"
                 class="param-input">
          <span class="param-desc">Training iterations</span>
        </div>

        <div class="param-group">
          <label for="batch-size">Batch Size:</label>
          <input type="number"
                 id="batch-size"
                 min="1"
                 max="64"
                 [(ngModel)]="batch_size"
                 class="param-input">
          <span class="param-desc">Images per batch</span>
        </div>

        <div class="param-group">
          <label for="val-split">Validation Split:</label>
          <input type="number"
                 id="val-split"
                 min="0.1"
                 max="0.5"
                 step="0.1"
                 [(ngModel)]="val_split"
                 class="param-input">
          <span class="param-desc">Test set ratio</span>
        </div>

        <div class="param-group">
          <label for="learning-rate">Learning Rate:</label>
          <input type="number"
                 id="learning-rate"
                 min="0.0001"
                 max="0.01"
                 step="0.0001"
                 [(ngModel)]="learning_rate"
                 class="param-input">
          <span class="param-desc">Training speed</span>
        </div>
      </div>

      <div class="training-options">
        <div class="option-group">
          <input type="checkbox"
                 id="use-lora"
                 [(ngModel)]="use_lora"
                 class="option-checkbox">
          <label for="use-lora" class="option-label">
            <strong>âš¡ Enable LoRA Fine-tuning</strong>
          </label>
          <div class="option-desc">
            âš¡ Parameter-efficient training (smaller models, faster training)
            <br>
            ğŸ‹ï¸â€â™‚ï¸ Full fine-tuning (better accuracy, slower training)
          </div>
        </div>
      </div>

      <div class="button-row">
        <button (click)="startTraining()"
                [disabled]="!canStartTraining()"
                class="start-training-btn">
          <span *ngIf="!isTraining()">ğŸš€ Start General Training</span>
          <span *ngIf="isTraining()">â³ Training in Progress...</span>
        </button>

        <button (click)="resetModel()"
                [disabled]="trainingStatus()?.current_model === 'YOLOv8n (Base)'"
                class="reset-model-btn">
          ğŸ”„ Reset to Base Model
        </button>
      </div>

      <div class="training-notice">
        â„¹ï¸ Training runs in the background. Use the training logs to monitor progress.
        <br>
        ğŸ”„ Reset button returns model to original YOLOv8n before fine-tuning.
      </div>
    </div>

    <!-- Specialized LoRA Training -->
    <div class="training-controls-card">
      <h3>ğŸ¯ Specialized LoRA Training</h3>
      <p>Train specialized LoRA adapters for specific tasks (digits, colors). Freeze base YOLO backbone, train only LoRA layers.</p>

      <div class="specialized-training-section">
        <!-- Training Type Selection -->
        <div class="training-type-selection">
          <h4>Select Training Task:</h4>
          <div class="training-type-buttons">
            <button (click)="trainingType.set('digits')"
                    [class.selected]="trainingType() === 'digits'"
                    class="training-type-btn">
              ğŸ”¢ Digits
            </button>
            <button (click)="trainingType.set('colors')"
                    [class.selected]="trainingType() === 'colors'"
                    class="training-type-btn">
              ğŸ¨ Colors
            </button>
          </div>
        </div>

        <!-- LoRA Training Parameters -->
        <div class="lora-params" *ngIf="trainingType()">
          <div class="param-group">
            <label for="lora-rank">LoRA Rank:</label>
            <input type="number"
                   id="lora-rank"
                   min="1"
                   max="32"
                   [(ngModel)]="loraRank"
                   class="param-input">
            <span class="param-desc">Adapter dimension (8 default)</span>
          </div>

          <div class="param-group">
            <label for="lora-learning-rate">Learning Rate:</label>
            <input type="number"
                   id="lora-learning-rate"
                   min="0.00001"
                   max="0.01"
                   step="0.00001"
                   [(ngModel)]="loraLearningRate"
                   class="param-input">
            <span class="param-desc">LoRA learning rate</span>
          </div>
        </div>

        <!-- Training Actions -->
        <div class="specialized-actions" *ngIf="trainingType()">
          <div class="action-buttons">
            <button *ngIf="trainingType() === 'digits'" (click)="sendSpecializedToBackend('digits')"
                    class="upload-btn">
              ğŸ“¤ Upload Digits Data
            </button>
            <button *ngIf="trainingType() === 'colors'" (click)="sendSpecializedToBackend('colors')"
                    class="upload-btn">
              ğŸ“¤ Upload Colors Data
            </button>

            <button *ngIf="trainingType() === 'digits'" (click)="startSpecializedTraining('digits')"
                    class="lora-train-btn">
              ğŸ§  Train LoRA (Freeze Base)
            </button>
            <button *ngIf="trainingType() === 'colors'" (click)="startSpecializedTraining('colors')"
                    class="lora-train-btn">
              ğŸ§  Train LoRA (Freeze Base)
            </button>

            <button *ngIf="trainingType() === 'digits'" (click)="loadLoraAdapter('digits')"
                    class="load-adapter-btn">
              ğŸ”Œ Load Digits Adapter
            </button>
            <button *ngIf="trainingType() === 'colors'" (click)="loadLoraAdapter('colors')"
                    class="load-adapter-btn">
              ğŸ”Œ Load Colors Adapter
            </button>
          </div>

          <div class="training-tip">
            ğŸ’¡ <strong>Tip:</strong> Upload specialized data, train LoRA adapter, then load the adapter for inference.
            <br>
            ğŸ§Š Base YOLO backbone remains frozen - only LoRA layers are trained!
          </div>
        </div>
      </div>
    </div>

    <!-- No Training Data Message -->
    <div class="empty-queue-message" *ngIf="!trainingStatus()?.ready_for_training && trainingStatus()?.images_waiting === 0">
      <div class="empty-icon">ğŸ“­</div>
      <h3>No Images Ready for Training</h3>
      <p>Upload and annotate some images in the "Detect" tab first.</p>
      <button (click)="activeTab.set('detect')" class="back-to-annotate">
        ğŸ·ï¸ Go Annotate Images
      </button>
    </div>

    <!-- Success/Error Messages -->
    <div class="message-card" *ngIf="hasError()">
      <div class="error-message">
        âŒ {{ trainingError() }}
      </div>
    </div>

    <div class="message-card" *ngIf="hasSuccess()">
      <div class="success-message">
        âœ… {{ trainingSuccess() }}
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
      <button (click)="loadTrainingStatus()" class="action-btn refresh-btn">
        ğŸ”„ Refresh Status
      </button>
    </div>
  </div>

  <!-- LOGS TAB CONTENT -->
  <div class="tab-content" *ngIf="activeTab() === 'logs'">
    <div class="logs-container">
      <h3>ğŸ“Š Training Logs</h3>

      <div class="logs-content" *ngIf="trainingLogs().length > 0">
        <div class="log-entry" *ngFor="let log of trainingLogs(); trackBy: trackByLog">
          <div class="log-header">
            <span class="log-timestamp">{{ formatDateTime(log.timestamp) }}</span>
            <span class="log-type" [class]="'log-type-' + (log.metadata?.type || 'info')">
              {{ log.metadata?.type || 'info' }}
            </span>
          </div>
          <div class="log-details">
            <div *ngIf="log.metadata?.epochs" class="log-item">
              <strong>Epochs:</strong> {{ log.metadata.epochs }}
            </div>
            <div *ngIf="log.epoch" class="log-item">
              <strong>Epoch:</strong> {{ log.epoch }}
            </div>
            <div *ngIf="log.accuracy" class="log-item">
              <strong>Accuracy:</strong> {{ log.accuracy.toFixed(4) }}
            </div>
            <div *ngIf="log.loss" class="log-item">
              <strong>Loss:</strong> {{ log.loss.toFixed(4) }}
            </div>
            <div *ngIf="log.val_accuracy" class="log-item">
              <strong>Val Accuracy:</strong> {{ log.val_accuracy.toFixed(4) }}
            </div>
            <div *ngIf="log.val_loss" class="log-item">
              <strong>Val Loss:</strong> {{ log.val_loss.toFixed(4) }}
            </div>
            <div *ngIf="log.metadata?.error" class="log-item error">
              <strong>Error:</strong> {{ log.metadata.error }}
            </div>
            <div *ngIf="log.metadata?.use_lora !== undefined" class="log-item">
              <strong>LoRA:</strong> {{ log.metadata.use_lora ? 'âœ… Enabled' : 'âŒ Disabled' }}
            </div>
            <div *ngIf="log.metadata?.learning_rate" class="log-item">
              <strong>Learn Rate:</strong> {{ log.metadata.learning_rate }}
            </div>
          </div>
        </div>
      </div>

      <div class="no-logs" *ngIf="trainingLogs().length === 0">
        <div class="no-logs-icon">ğŸ“</div>
        <h3>No Training Logs Yet</h3>
        <p>Start training to see logs here.</p>
      </div>

      <div class="logs-actions">
        <button (click)="loadTrainingLogs()" class="refresh-logs-btn">
          ğŸ”„ Refresh Logs
        </button>
      </div>
    </div>
  </div>
</div>
